---
draft: true
params:
  boj: 18591
  bojTitle: Faraway
---

## 문제 내용

$x$좌표와 $y$좌표가 0 이상 $m$ 이하인 정사각형 영역에 $n$개의 점이 있고, 위치를 알 수 없는 하나의 목표물이 있습니다.
이들의 좌표는 모두 정수입니다.

$n$개의 점 각각에 대해, 그 점의 좌표 $(x_i, y_i)$, 그리고 그 점과 목표물 간의 맨해튼 거리를 $k_i$로 나눈 나머지가 $t_i$라는 정보가 주어질 때, 가능한 목표물의 위치의 개수를 구하세요. $n$개의 점의 좌표는 서로 같을 수 있고, 목표물이 어떤 점과 같은 위치에 있을 수도 있습니다.

### 입력

첫 줄에는 테스트 케이스의 개수 $T$가 주어집니다. ($1 \le T \le 10$)

각 테스트 케이스에 대해, 첫 줄에는 $n$과 $m$의 값이 주어집니다. ($1 \le n \le 10$, $1 \le m \le 10^9$)

그다음 $n$줄에 걸쳐서 각 줄에 각 점에 대한 정보 $x_i, y_i, k_i, t_i$가 주어집니다. ($0 \le x_i, y_i \le m$, $2 \le k_i \le 5$, $0 \le t_i < k_i$)

## 문제 풀이

{{% details title="스포일러" closed="true" %}}

맨해튼 거리 조건은 그 점을 기준으로 사분면으로 나누면 $x + y = a (\bmod m)$ 조건이나 $x - y = a (\bmod m)$ 조건으로 만들 수 있습니다. $n$개의 점에 대해 각각 사분면으로 나눈 조합의 교집합을 모두 구하면 $4^n$가지의 경우의 수가 발생합니다. 그런데 여기에 $n$과 $t$가 곱해지면 제한 시간이 굉장히 빡빡하므로, $n$을 떼기 위해 재귀 백트래킹으로 구현해 줍니다.

사분면으로 나눌 때는 다음과 같이 풍차 날개 모양으로 분할하면 겹치거나 빠지는 것 없이 분할할 수 있습니다.

```
AAABBBB
AAABBBB
AAABBBB
AAAxDDD
CCCCDDD
CCCCDDD
CCCCDDD
```

그런데 이렇게 나누면 그 점 자체의 위치가 세어지지 않으므로, 점의 위치의 목록을 모아서 중복을 제거한 다음 각각의 점이 모든 조건을 충족하는지를 따로 확인하여 세어 줍니다. 이 부분은 $n$이 매우 작으므로 아무렇게나 구현해도 됩니다.

각 영역의 교집합은 $x$의 최대/최소, $y$의 최대/최소를 유지하여 구할 수 있습니다. 이때 모듈로 방정식을 합성해야 하는데, $k_i$의 범위가 매우 작으므로 최종적으로 모든 모듈로는 60의 약수임을 이용하여, 방정식의 조건을 60비트짜리 비트마스크로 변환할 수 있습니다. 모든 나눗수와 나머지의 조합에 대한 비트마스크를 미리 계산해 놓으면, 재귀할 때마다 하나의 `&` 연산만을 이용하여 방정식을 합성할 수 있습니다.

백트래킹 과정에서, $x$좌표나 $y$좌표의 구간이 공집합이 되었거나 한쪽 방정식의 나머지의 집합이 공집합이 되었다면 커팅을 해 줍니다.

마지막으로 다음의 방정식이 만들어졌다고 해 봅시다. 각 방정식은 각각 60으로 나눈 나머지들의 집합으로 표현되어 있으므로, 다음과 같은 형태의 연립방정식이 최대 3600개 있는 형태가 됩니다.

* $x + y \equiv r_1 (\bmod 60)$
* $x - y \equiv r_2 (\bmod 60)$

이 방정식은 $r_1$과 $r_2$의 홀짝이 같을 때만 해가 존재하며, 그 해는 $x \equiv \frac{r_1 + r_2}{2} (\bmod 30), y \equiv r_1 - x (\bmod 60)$입니다. $\bmod 60$으로 나타내면 두 개의 해의 쌍이 만들어집니다.

이제 $x$의 최대/최소를 가지고 $0 \le i < 60$에 대해 $x_{min} \le x \le x_{max}, x \equiv i (\bmod 60)$인 $x$의 개수를 구하고, 마찬가지로 나머지별 $y$의 개수를 구한 다음, 각각의 해에 대해 그에 맞는 $x$의 개수와 $y$의 개수를 곱하여 답에 더해주면 됩니다.

{{% /details %}}
